<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Gilded Rose kata revisited" /><meta property="og:locale" content="en_US" /><meta name="description" content="If you are into coding dojos and solving katas, you might have already tried the Gilded Rose kata by Emily Bache. In this kata, you are given some existing code that handles the quality and the number of days before expiration properties of the products in a store. The code handles almost everything in one single huge function. Unsurprisingly, the goal of the kata is to refactor the code. Besides, there is also a new functionality to implement." /><meta property="og:description" content="If you are into coding dojos and solving katas, you might have already tried the Gilded Rose kata by Emily Bache. In this kata, you are given some existing code that handles the quality and the number of days before expiration properties of the products in a store. The code handles almost everything in one single huge function. Unsurprisingly, the goal of the kata is to refactor the code. Besides, there is also a new functionality to implement." /><link rel="canonical" href="https://www.sandordargo.com/blog/2018/08/08/gilded-rose-revisited" /><meta property="og:url" content="https://www.sandordargo.com/blog/2018/08/08/gilded-rose-revisited" /><meta property="og:site_name" content="Sandor Dargo’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-08-08T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Gilded Rose kata revisited" /><meta name="twitter:site" content="@SandorDargo" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-12-26T06:39:58+01:00","datePublished":"2018-08-08T00:00:00+02:00","description":"If you are into coding dojos and solving katas, you might have already tried the Gilded Rose kata by Emily Bache. In this kata, you are given some existing code that handles the quality and the number of days before expiration properties of the products in a store. The code handles almost everything in one single huge function. Unsurprisingly, the goal of the kata is to refactor the code. Besides, there is also a new functionality to implement.","headline":"Gilded Rose kata revisited","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.sandordargo.com/blog/2018/08/08/gilded-rose-revisited"},"url":"https://www.sandordargo.com/blog/2018/08/08/gilded-rose-revisited"}</script><title>Gilded Rose kata revisited | Sandor Dargo's Blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-89625019-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-89625019-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/SANDOR_DARGO_ROUND.JPG" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Sandor Dargo's Blog</a></div><div class="site-subtitle font-italic">On C++, software development and books</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/books/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>BOOKS</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-microphone ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a><li class="nav-item"> <a href="/dailycpp/" class="nav-link"> <i class="fa-fw fas fa-link ml-xl-3 mr-xl-3 unloaded"></i> <span>DAILY C++</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>HI...</span> </a></ul><ul class="w-100"><li class="nav-item"> <a href="https://www.patreon.com/sandordargo" class="nav-link"> <img src="https://c5.patreon.com/external/logo/become_a_patron_button.png"></a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/sandordargo" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/SandorDargo" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sandor.dargo','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/blog"> Blog </a> </span> <span> <a href="/2018"> 2018 </a> </span> <span> <a href="/08"> 08 </a> </span> <span> <a href="/08"> 08 </a> </span> <span>Gilded Rose kata revisited</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Gilded Rose kata revisited</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Sandor Dargo </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Aug 8, 2018, 12:00 AM +0200" prep="on" > Aug 8, 2018 <i class="unloaded">2018-08-08T00:00:00+02:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Dec 26, 2024, 6:39 AM +0100" prefix="Updated " > Dec 26, 2024 <i class="unloaded">2024-12-26T06:39:58+01:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1829 words">10 min</span></div></div><div class="post-content"><p>If you are into coding dojos and solving katas, you might have already tried the <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata">Gilded Rose kata</a> by <a href="https://twitter.com/emilybache?lang=en">Emily Bache</a>.</p><p>In this kata, you are given some existing code that handles the quality and the number of days before expiration properties of the products in a store. The code handles almost everything in one single huge function. Unsurprisingly, the goal of the kata is to refactor the code. Besides, there is also a new functionality to implement.</p><p>I’ve done this kata a couple of times before, but recently when I did it again with my team, we took and we discussed a totally different approach and I want to share some of its aspects.</p><p>But first things first. How did I do it before?</p><p>Let’s start with the testing aspect.</p><p>Either I just automated the execution and evaluation of the <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata/blob/master/cpp/GildedRoseTextTests.cc">characterization tests</a> or I implemented the unit tests. In the latter case, I read scrupulously the <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata/blob/master/README.md">requirements</a> and I added the unit tests one by one. If I found a bug in the implementation, I fixed it or documented it depending on the discussion I had with my partner. In my opinion, it’s not evident what you should do in such a situation. Probably the buggy behaviour is acceptable because possibly your clients take that buggy output granted/by-design and you’d actually break their flow in case you fixed the bug you identified. Such cases happen to us in real life too, especially when we are maintaining long-lived products.</p><p>The approach I take for testing can have an effect on the way I refactor the code. When I use only the characterisation tests, usually I use the capabilities of my IDE for the refactoring. I extract till I drop and I rename as much as I can. Once the code is a little bit more readable, I start to do some manual refactorings as well.</p><p>If I implement unit tests one by one, I might be more adventurous with refactoring/reimplementing the small pieces of functionalities. From the very beginning.</p><p>How the code will be structured might highly depend on the choice of your language/IDE combination. For example with C++ and Eclipse, you cannot extract some code into a new class, whereas you can do it with Java and IntelliJ (maybe with Java and Eclipse too). In other terms, it’s easier to end up with a more object-oriented code with Java than with C++ without thinking too much. (Is that a good thing? I leave that to you.)</p><p>On this occasion, to save some time, we decided to stay only with the characterization tests. Our main goal was to try <a href="https://martinfowler.com/bliki/BranchByAbstraction.html">branching by abstraction</a>.</p><p>The main idea behind this model is to have a deployable version of the code after each small step that can be either refactoring or implementing a new feature. Why is this so important? Because using this approach, one can perform big changes without maintaining a long-lived feature branch. You free yourself from merging troubles and what you are doing is transparent to your peers.</p><p>Let’s see step by step how we implemented the <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata">Gilded Rose kata</a>!</p><h1 id="step-1-extracting-the-body-of-the-of-the-for-loop">Step 1: <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/65a26523958d1c6b7eb2f9e8d81cf80492a8adc8">extracting the body of the of the for loop</a>.</h1><p>This step is quite evident. I also changed how the iteration happens, so instead of referring to the elements by their index, I changed to a range-based <code class="language-plaintext highlighter-rouge">for</code> loop - this step required to upgrade the C++ version to C++11.</p><h1 id="step-2-implement-the-quality-and-sellin-behaviour-for-non-special-items">Step 2: <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/ac069ef55e1a5cd5a0c512faad6b104ecc4bbc30">Implement the quality and sellIn behaviour for non-special items</a>.</h1><p>And here it comes, the branching-by-abstraction. We introduce a big <code class="language-plaintext highlighter-rouge">if-else</code>.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">"Ragnaroos"</span> <span class="p">...)</span> <span class="p">{</span>
  <span class="c1">// freshly implemented behaviour</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// old code</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In case the item is a non-special one, the new piece of code is used but in all other cases still, the old behaviour is executed.</p><h1 id="step-3-move-the-updates-to-the-item-class">Step 3: <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/ce61820212f68e536ef189675a253edd65c786d1">Move the updates to the Item class</a></h1><p>As <code class="language-plaintext highlighter-rouge">quality</code> and <code class="language-plaintext highlighter-rouge">sellIn</code> are attributes of an item, it makes sense to maintain them in the <code class="language-plaintext highlighter-rouge">Item</code> object. At this point, we might be tempted to introduce methods such as <code class="language-plaintext highlighter-rouge">decreaseQuality</code> and <code class="language-plaintext highlighter-rouge">decreaseSellIn</code>, but it would mean a quite short-term dead-end, so better to stick with the more abstract <code class="language-plaintext highlighter-rouge">updateQuality</code> and <code class="language-plaintext highlighter-rouge">updateSellIn</code> names.</p><h1 id="step-4-implement-the-behaviour-for-the-special-item-of-sulfuras-hand-of-ragnaros">Step 4: <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/c63ed5e9a9406582b82f4833447b3ab074900885">Implement the behaviour for the special item of “Sulfuras, Hand of Ragnaros”</a></h1><p>According to the specs, <em>Sulfuras</em> does not age and its quality rests the same. There is nothing to do with their attributes! If you run forward, there is already a chance here to refactor, but it’s not really needed at this moment. So the code is as simple as that:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">"Sulfuras..."</span><span class="p">)</span> <span class="p">{</span>
  
<span class="p">}</span>
</pre></table></code></div></div><h1 id="step-5-implement-the-behaviour-for-aged-brie">Step 5: <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/f47e38300412b33ec0b3a3df1dfacf3b481f8578">Implement the behaviour for Aged Brie</a></h1><p>While the quality of normal items decreases over time, <em>Aged Brie</em>’s increases and not even with the same speed. This means we cannot simply reuse <code class="language-plaintext highlighter-rouge">Item::updateQuality</code>. At this point, we implemented the behaviour right there in the <code class="language-plaintext highlighter-rouge">processItem</code> method. If you have a deeper look, although the tests pass, the implementation is not completely in line with what the specs say. Or maybe the specs are not so well written. Who knows? This time, I decided to stay with the already existing behaviour.</p><p>This was the point when things started to get complicated.</p><p>For non-special items, the behaviour is completely encapsulated in the <code class="language-plaintext highlighter-rouge">Item</code> class. For <em>Sulfuras</em> and <em>Aged Brie</em>, the behaviour is in the <code class="language-plaintext highlighter-rouge">GildedRose::processItem</code> function. It seems quite obvious that this is not optimal, and it’d be good to have all the different behaviours implemented in the <code class="language-plaintext highlighter-rouge">Item</code> class.</p><p>One option would be to make <code class="language-plaintext highlighter-rouge">Item</code> a base class with virtual <code class="language-plaintext highlighter-rouge">updateQuality</code> and <code class="language-plaintext highlighter-rouge">updateSellIn</code> methods, but I was not fond of the idea. It didn’t seem like a small refactoring. Besides, I reminded myself of the <a href="https://en.wikipedia.org/wiki/Liskov_substitution_principle">Liskov Substitution Principle</a>. Whenever an <code class="language-plaintext highlighter-rouge">Item</code> is expected, I wouldn’t be able to use an <code class="language-plaintext highlighter-rouge">AgedBrieItem</code> for example as <code class="language-plaintext highlighter-rouge">AgedBrieItem</code> doesn’t extend but alters the default behaviour. Yet the biggest problem would have been that change of the instantiation. The burden of updating all the tests, and imagine if our clients are using the <code class="language-plaintext highlighter-rouge">Item</code> class…</p><p>My colleague who organized the dojo presented us another idea suited for this kind of problems. Hide the changing implementation details in another class, thus we don’t have to transform Item into a common parent. We don’t even have to change how the Items are instantiated. It sounded good enough for us. Here it comes.</p><h1 id="step-6-extract-the-behaviour-handling-into-an-updater-class">Step 6: <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/32b9b235d242fee994cac6bf4f394fbc73a52dad">Extract the behaviour handling into an <code class="language-plaintext highlighter-rouge">Updater</code> class</a></h1><p>So while Item is still is still instantiated the same way with a name, a quality and a sellIn date, it’s internal structure changes. Yes, the size of your class changes and your clients will have to recompile, but I think this is less and less issue these days. On the other hand, they will not have to change their code, because you only modified your internal structure at this point.</p><p>In the constructor of the <code class="language-plaintext highlighter-rouge">Item</code> class, or in a method which is called from the constructor, based on the Item name an <code class="language-plaintext highlighter-rouge">Updater</code> will be created.</p><p>Then the <code class="language-plaintext highlighter-rouge">Item::updateQuality()</code> and <code class="language-plaintext highlighter-rouge">Item::updateSellIn()</code> will delegate the work to <code class="language-plaintext highlighter-rouge">Update</code> class’ corresponding methods.</p><p>In order not to violate the Liskov principle, we shall not use inheritance. In this use case, derived classes would not extend the base class’ behaviour they would simply alter it, which goes against our principles.</p><p>As in C++, there is no built-in concept for interfaces, I created an abstract base class that contains only pure virtual functions - apart from the constructor/destructor. Then I created the first three Updater classes, namely DefaultUpdater, RagnarosUpdater and AgedBrieUpdater.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Updater</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="n">Updater</span><span class="p">(</span><span class="kt">int</span><span class="o">&amp;</span> <span class="n">sellIn</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">quality</span><span class="p">)</span> <span class="o">:</span> <span class="n">_quality</span><span class="p">(</span><span class="n">quality</span><span class="p">),</span> <span class="n">_sellIn</span><span class="p">(</span><span class="n">sellIn</span><span class="p">)</span> <span class="p">{}</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">Updater</span><span class="p">()</span> <span class="p">{};</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">updateQuality</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">updateSellIn</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="k">protected</span><span class="o">:</span>
  <span class="kt">int</span><span class="o">&amp;</span> <span class="n">_quality</span><span class="p">;</span>
  <span class="kt">int</span><span class="o">&amp;</span> <span class="n">_sellIn</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><p>I went through many iterations and commits before the Updater class actually reached this point and I had to tackle one serious bug that I’ll cover in more details in another blog post.</p><h1 id="step-7-create-the-updater-classes-for-the-rest">Step 7: <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/48ae24e02ed93d587331eaff1f2dba63d5e91850">Create the Updater classes for the rest</a></h1><p>At this point, I still had to implement two updater classes. One for the backstage passes and one for the Conjured items which is a new feature. At this point, these are only handwork exercises.</p><h1 id="step-8-remove-the-original-branch-of-code">Step 8: <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/fcfa2ca3826f865c03bfea33808d6701c64add28">Remove the Original branch of code</a></h1><p>You might have noticed that up until this step, my big if-else was just growing in <code class="language-plaintext highlighter-rouge">GildedRose::processItem</code> which was not necessary, but I didn’t want to touch in. Instead, I remove it completely now. As such, the whole function will be only two lines long.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">GildedRose</span><span class="o">::</span><span class="n">processItem</span><span class="p">(</span><span class="n">Item</span><span class="o">&amp;</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">item</span><span class="p">.</span><span class="n">updateSellIn</span><span class="p">();</span>
  <span class="n">item</span><span class="p">.</span><span class="n">updateQuality</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="step-9-any-cleanups-to-do">Step 9: Any cleanups to do</h1><p>We are done with the bigger part of the refactoring as well as with the implementation of the new feature. Let’s look for other refactorings to do.</p><p>The <code class="language-plaintext highlighter-rouge">GildedRose</code> class seems quite fine, but in fact, I don’t think we need <code class="language-plaintext highlighter-rouge">processItem</code>. It shouldn’t know which two functions of an <code class="language-plaintext highlighter-rouge">Item</code> have to be invoked and it shouldn’t know the order of the invocation either. <code class="language-plaintext highlighter-rouge">GildedRose::updateQuality</code> seems to be a very bad name.</p><p>Once <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/fcfa2ca3826f865c03bfea33808d6701c64add28">it was done</a>, I decided to clean up the <code class="language-plaintext highlighter-rouge">GildedRose.h</code> in a sense that I moved every class definition to its own header and the implementation to the corresponding source files. Up to this point, it was convenient to work in one file, but it’s time to move things where they belong to. It will give us the possibility to make some further refactorings, after we can use includes and forward declarations properly.</p><p>This step also required to <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/345e0e7ae173976af963dff31d9cfb7345e5782f">modify our Makefile, to include all the new files to the build</a>.</p><p>Finally, I could <a href="https://github.com/sandordargo/GildedRose-Refactoring-Kata/commit/0f94efb095c8562fdc52574e3325181b15279599">remove the instantiation of the <code class="language-plaintext highlighter-rouge">Updater</code> from the <code class="language-plaintext highlighter-rouge">Items</code> consturctor</a>, and I moved it to a static factory method inside the <code class="language-plaintext highlighter-rouge">Updater</code> interface/abstract class.</p><p>I could see some other possibilities to refactor, but at one point, one has to stop. I stopped here.</p><h2 id="takeaways">Takeaways</h2><p>I’ve worked on the <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata">Gilded Rose kata</a> a couple of times, and even though it was a bit different every time, this was far the most interesting occasion.</p><p>To me the most interesting concepts were:</p><ul><li><p>Delegate to another class (hierarchy) the work, so that you don’t have to make your client facing a new class hierarchy instead of the one single class he used to have. As such, I could keep the instantiation the same all the time. I didn’t have to change the existing tests.</p><li><p>I used the idea behind abstraction by branch. The new code was used for the parts I already finished refactoring/reimplement, while I didn’t touch the old code at all. In the end, I could remove all the old code at once. This seems indeed quite same for implementing bigger migrations or to conduct massive refactorings.</p></ul><p>I’d encourage you to do the <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata">Gilded Rose kata</a> and to document how it went.</p><a href="https://www.patreon.com/sandordargo" style="float: left; padding-left: 0;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://c5.patreon.com/external/logo/become_a_patron_button.png" style="float: left; padding-left: 0;"></a></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/dev/'>dev</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cpp/" class="post-tag no-text-decoration" >cpp</a> <a href="/tags/dojo/" class="post-tag no-text-decoration" >dojo</a> <a href="/tags/gilded-rose/" class="post-tag no-text-decoration" >gilded rose</a> <a href="/tags/branch-by-abstraction/" class="post-tag no-text-decoration" >branch by abstraction</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><a href="https://www.patreon.com/sandordargo" style="float: left; padding-left: 0;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://c5.patreon.com/external/logo/become_a_patron_button.png" style="float: left; padding-left: 0;"></a><div class="share-wrapper"> <a href="https://www.patreon.com/sandordargo" style="float: left; padding-left: 0;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://c5.patreon.com/external/logo/become_a_patron_button.png" style="float: left; padding-left: 0;"></a> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Gilded Rose kata revisited - Sandor Dargo's Blog&url=https://www.sandordargo.com/blog/2018/08/08/gilded-rose-revisited" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Gilded Rose kata revisited - Sandor Dargo's Blog&u=https://www.sandordargo.com/blog/2018/08/08/gilded-rose-revisited" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Gilded Rose kata revisited - Sandor Dargo's Blog&url=https://www.sandordargo.com/blog/2018/08/08/gilded-rose-revisited" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://news.ycombinator.com/submitlink?t=Gilded Rose kata revisited - Sandor Dargo's Blog&u=https://www.sandordargo.com/blog/2018/08/08/gilded-rose-revisited" data-toggle="tooltip" data-placement="top" title="HackerNews" target="_blank" rel="noopener" aria-label="HackerNews"> <i class="fa-fw fab fa-hacker-news"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2026/01/21/clocks-part-8-cpp20-timezones">Time in C++: C++20 Brought Us Time Zones</a><li><a href="/blog/2019/04/10/lesson-of-a-booking-dont-trust-the-system">Lesson of a booking: Don't trust the system!</a><li><a href="/blog/2020/07/22/always-catch-exceptions-by-reference">Why should we always catch exceptions by reference?</a><li><a href="/blog/2020/11/28/emergent-design">Emergent Design: The Evolutionary Nature of Professional Software Development by Scott Bain</a><li><a href="/blog/2021/10/06/airy-code-reviews">Bring some fresh AIR and write effective code review comments</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/watercooler/">watercooler</a> <a class="post-tag" href="/tags/career/">career</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/cpp23/">cpp23</a> <a class="post-tag" href="/tags/stl/">stl</a> <a class="post-tag" href="/tags/algorithms/">algorithms</a> <a class="post-tag" href="/tags/self-improvement/">self-improvement</a> <a class="post-tag" href="/tags/management/">management</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2018/08/29/deliberate-practice-and-memory-management"><div class="card-body"> <span class="timeago small" > Aug 29, 2018 <i class="unloaded">2018-08-29T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deliberate practice and memory management</h3><div class="text-muted small"><p> I have recently read the eye-opening book of Cal Newport, So Good They Can’t Ignore You. He emphasizes a lot on the importance of deliberate practice. I also decided to take a bit more seriously my...</p></div></div></a></div><div class="card"> <a href="/blog/2017/06/07/tdd-as-if-you-meant-it"><div class="card-body"> <span class="timeago small" > Jun 7, 2017 <i class="unloaded">2017-06-07T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TDD as if you meant it</h3><div class="text-muted small"><p> The kata we picked was TDD as if you meant it. The rules are the ones of TDD, plus some additionals. These rules - such as write the code first at the test class and don’t move it until… - are not ...</p></div></div></a></div><div class="card"> <a href="/blog/2024/07/10/cpponsea2024-trip-report"><div class="card-body"> <span class="timeago small" > Jul 10, 2024 <i class="unloaded">2024-07-10T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Trip report: C++ On Sea 2024</h3><div class="text-muted small"><p> Last week, between the 3rd and 5th of July, I had the privilege to attend and present at C++ on Sea 2024 for the 5th time in a row! I’m grateful that the organizers accepted me not simply as a spe...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2018/07/25/the-four-hour-body" class="btn btn-outline-primary" prompt="Older"><p>The 4 Hour Body by Timothy Ferriss</p></a> <a href="/blog/2018/08/15/stop-reading" class="btn btn-outline-primary" prompt="Newer"><p>Stop reading!</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//sandordargo-github-io.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Gilded Rose kata revisited'; this.page.url = 'https://www.sandordargo.com/blog/2018/08/08/gilded-rose-revisited'; this.page.identifier = '/blog/2018/08/08/gilded-rose-revisited'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><div id="amzn-assoc-ad-be5a767b-3346-40aa-bc00-2eff0ce33d2b"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=be5a767b-3346-40aa-bc00-2eff0ce33d2b"></script> <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script> <script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">require(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us16.list-manage.com","uuid":"b073dbd5c29322302f59a8cd8","lid":"d26240427e"}) })</script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/SandorDargo">Sandor Dargo</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/watercooler/">watercooler</a> <a class="post-tag" href="/tags/career/">career</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/cpp23/">cpp23</a> <a class="post-tag" href="/tags/stl/">stl</a> <a class="post-tag" href="/tags/algorithms/">algorithms</a> <a class="post-tag" href="/tags/self-improvement/">self improvement</a> <a class="post-tag" href="/tags/management/">management</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.sandordargo.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
