<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Mocking non-virtual and free functions with gMock" /><meta property="og:locale" content="en_US" /><meta name="description" content="Last time we started to discover gMock and we went into details regarding how we can mock virtual functions. We saw how to indicate that a function is to be mocked, how to provide a canned behaviour for them and how to make assertions on whether they are called or not and with what inputs." /><meta property="og:description" content="Last time we started to discover gMock and we went into details regarding how we can mock virtual functions. We saw how to indicate that a function is to be mocked, how to provide a canned behaviour for them and how to make assertions on whether they are called or not and with what inputs." /><link rel="canonical" href="https://www.sandordargo.com/blog/2022/03/09/mocking-non-virtual-and-free-functions" /><meta property="og:url" content="https://www.sandordargo.com/blog/2022/03/09/mocking-non-virtual-and-free-functions" /><meta property="og:site_name" content="Sandor Dargo’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-09T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Mocking non-virtual and free functions with gMock" /><meta name="twitter:site" content="@SandorDargo" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-09T00:00:00+01:00","datePublished":"2022-03-09T00:00:00+01:00","description":"Last time we started to discover gMock and we went into details regarding how we can mock virtual functions. We saw how to indicate that a function is to be mocked, how to provide a canned behaviour for them and how to make assertions on whether they are called or not and with what inputs.","headline":"Mocking non-virtual and free functions with gMock","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.sandordargo.com/blog/2022/03/09/mocking-non-virtual-and-free-functions"},"url":"https://www.sandordargo.com/blog/2022/03/09/mocking-non-virtual-and-free-functions"}</script><title>Mocking non-virtual and free functions with gMock | Sandor Dargo's Blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-89625019-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-89625019-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/SANDOR_DARGO_ROUND.JPG" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Sandor Dargo's Blog</a></div><div class="site-subtitle font-italic">On C++, software development and books</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/books/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>BOOKS</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-microphone ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a><li class="nav-item"> <a href="/dailycpp/" class="nav-link"> <i class="fa-fw fas fa-link ml-xl-3 mr-xl-3 unloaded"></i> <span>DAILY C++</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>HI...</span> </a></ul><ul class="w-100"><li class="nav-item"> <a href="https://www.patreon.com/sandordargo" class="nav-link"> <img src="https://c5.patreon.com/external/logo/become_a_patron_button.png"></a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/sandordargo" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/SandorDargo" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sandor.dargo','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/blog"> Blog </a> </span> <span> <a href="/2022"> 2022 </a> </span> <span> <a href="/03"> 03 </a> </span> <span> <a href="/09"> 09 </a> </span> <span>Mocking non-virtual and free functions with gMock</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Mocking non-virtual and free functions with gMock</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Sandor Dargo </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Mar 9, 2022, 12:00 AM +0100" prep="on" > Mar 9, 2022 <i class="unloaded">2022-03-09T00:00:00+01:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1767 words">9 min</span></div></div><div class="post-content"><p><a href="https://www.sandordargo.com/blog/2022/03/02/mocking-non-virtual-and-free-functions">Last time we started to discover <code class="language-plaintext highlighter-rouge">gMock</code></a> and we went into details regarding how we can mock <code class="language-plaintext highlighter-rouge">virtual</code> functions. We saw how to indicate that a function is to be mocked, how to provide a canned behaviour for them and how to make assertions on whether they are called or not and with what inputs.</p><p>Today, we are going to continue our quest by mocking non-<code class="language-plaintext highlighter-rouge">virtual</code> members and free-standing functions.</p><p>I must mention before we discuss the details that I try not to repeat lots of information from the <a href="https://www.sandordargo.com/blog/2022/03/02/mocking-non-virtual-and-free-functions">previous article</a>. In particular, I don’t share again how to build up <code class="language-plaintext highlighter-rouge">ON_CALL</code> or <code class="language-plaintext highlighter-rouge">EXPECT_CALL</code> commands. Those work the same both for <code class="language-plaintext highlighter-rouge">virtual</code> and non-<code class="language-plaintext highlighter-rouge">virtual</code> functions. Please visit the <a href="https://www.sandordargo.com/blog/2022/03/02/mocking-non-virtual-and-free-functions">previous article</a> if you are interested in those parts.</p><p>Let’s get down to business!</p><h2 id="how-to-mock-a-non-virtual-function">How to mock a non-virtual function?</h2><p>Now that we know how to mock a <code class="language-plaintext highlighter-rouge">virtual</code> function, let’s discuss whether we can mock a non-<code class="language-plaintext highlighter-rouge">virtual</code> one. While the <a href="https://github.com/google/googletest/blob/master/docs/gmock_cook_book.md#mocking-non-virtual-methods-mockingnonvirtualmethods">gmock cook book</a> says it can be easily done, I tend to disagree with the <em>easily</em> part. At least it’s far from convenient.</p><p>The great thing about mocking <code class="language-plaintext highlighter-rouge">virtual</code> functions is that you don’t need to change the production code at all- unless they are private. It’s not the case for non-<code class="language-plaintext highlighter-rouge">virtual</code>s.</p><p>Let’s assume that we have the same interface as before, but without the methods being <code class="language-plaintext highlighter-rouge">virtual</code> and of course without any abstract functions:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Car</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="o">~</span><span class="n">Car</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">startEngine</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// some implementation</span>
  <span class="p">}</span>
  
  <span class="kt">int</span> <span class="nf">getTrunkSize</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="c1">// some implementation</span>
  <span class="p">}</span>
  
  <span class="kt">void</span> <span class="n">addFuel</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// some implementation</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></table></code></div></div><p>We have to create the mocked class the very same way as before except for the <code class="language-plaintext highlighter-rouge">override</code> specifier and also we don’t inherit from any class. Given that we have no <code class="language-plaintext highlighter-rouge">virtual</code>, there is nothing to override:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MockCar</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">MOCK_METHOD</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">startEngine</span><span class="p">,</span> <span class="p">(),</span> <span class="p">());</span>
  <span class="n">MOCK_METHOD</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">getTrunkSize</span><span class="p">,</span> <span class="p">(),</span> <span class="p">(</span><span class="k">const</span><span class="p">));</span>
  <span class="n">MOCK_METHOD</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">addFuel</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">),</span> <span class="p">());</span>
<span class="p">};</span>
</pre></table></code></div></div><p>So what we have now are two completely unrelated classes (no inheritance!) with the same signatures, same interface. We have to relate them somehow! We have to be able to tell the code which implementations are to be used and without the virtual dispatching. We have to do this at compile time.</p><p>The <a href="https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#mocking-non-virtual-methods-mockingnonvirtualmethods">cookbook suggest templatizing our code</a>. This is far from being an easy and comfortable solution to me.</p><p>We have to extract the code where mocked methods are used and replace them with forwarding calls to the implementation that is passed as a template argument.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">CarImpl</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">CarWrapper</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">CarWrapper</span><span class="p">(</span><span class="n">C</span> <span class="n">carImpl</span><span class="p">)</span><span class="o">:</span> <span class="n">_carImpl</span><span class="p">(</span><span class="n">carImpl</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="nf">startEngine</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_carImpl</span><span class="p">.</span><span class="n">startEngine</span><span class="p">();</span>
  <span class="p">}</span>
  
  <span class="kt">int</span> <span class="nf">getTrunkSize</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">_carImpl</span><span class="p">.</span><span class="n">getTrunkSize</span><span class="p">();</span>
  <span class="p">}</span>
  
  <span class="kt">void</span> <span class="nf">addFuel</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_carImpl</span><span class="p">.</span><span class="n">addFuel</span><span class="p">();</span>
  <span class="p">}</span> 
<span class="k">private</span><span class="o">:</span>
  <span class="n">CarImpl</span> <span class="n">_carImpl</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now that we wrapped the implementation, what is rest is to replace all the calls to <code class="language-plaintext highlighter-rouge">Car</code> in production code with the instantiation of the wrapper:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">CarWrapper</span><span class="o">&lt;</span><span class="n">Car</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">;</span>
</pre></table></code></div></div><p>And then the calls can stay the same.</p><p>In the unit tests, we have to do the same, but with <code class="language-plaintext highlighter-rouge">MockedCar</code>:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">CarWrapper</span><span class="o">&lt;</span><span class="n">MockedCar</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">;</span>
</pre></table></code></div></div><p>I wouldn’t say that this is a complex technique, but it does require some modifications, you have to add a new templatized wrapper to your codebase and you also have to change all the places where the wrapped object is used.</p><p>What you gain though is not introducing inheritance and vtables. You have to put everything on the balance and decide if it’s worth it in your case.</p><p>This implementation is not exactly what the cook book suggests, though it’s very similar. In the cook book, the calls on the class under test were not exactly forwarded, but the calls and the surrounding code were wrapped into functions with a different name compared to the existing functions in the original object.</p><p>I think that suggestion goes too far. Templatizing the to be mocked functions and extracting code at the same time is a mixture of two steps.</p><p>I would rather suggest taking two steps:</p><ul><li>replace the to be mocked object with its wrapper<li>do the code extractions at your will, but not in the class template</ul><p>This will help you to go in baby steps and to keep your changes small. Your code will be also clearer at the end.</p><h3 id="how-to-mock-a-free-or-a-static-function">How to mock a free or a static function</h3><p>Mocking a free or <code class="language-plaintext highlighter-rouge">static</code> function also requires changes. You can choose the direction you take.</p><p>If you want easy mocking, you can turn a free or a static function into a virtual member function. For free functions, this requries even to create a class around them.</p><p>The other way around is wrapping these functions with a templated layer as we saw for in the previous section. It’s worth noting that with C++20 and with <a href="https://www.sandordargo.com/blog/2021/02/10/cpp-concepts-motivations">the introduction of concepts</a> and requires expressions, it’s easy to communicate and enforce the types that can be used with a given template.</p><p>In most cases, I’d go with the templatization to avoid introducing a new class when it’s not needed. Moreover to avoid introducting virtual tables when it’s clearly not necessary.</p><h2 id="some-common-pitfalls-to-avoid">Some common pitfalls to avoid</h2><p>While you are learning to use mocking in your unit tests, you will run into problems. Here is a collection of some common mistakes to avoid. Comment yours with your solutions and I’ll keep enriching this list.</p><h3 id="stating-your-expectation-after-exercising-the-code">Stating your expectation after exercising the code</h3><p>A regular unit test generally follows the <em>AAA</em> pattern:</p><ul><li>Arrange<li>Act<li>Assert</ul><p>This means that first, you <em>arrange</em>, you set up all the necessary objects that you need to <em>act</em>, to <em>execute</em> your code. And finally, you <em>assert</em> the result.</p><p>When it comes to mocking, it’s a bit different. After making your <em>arrangements</em>, you have to set either your expectations and reactions (corresponding more or less to the <em>assert</em> part). And only then you should execute your code (<em>act</em>).</p><p>Otherwise if you <em>act</em> before you arrange, <em>gMock</em> will not be able to match the expectations. The expectation will stay unsatisfied and active.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">TEST</span><span class="p">(</span><span class="n">CarMockTest</span><span class="p">,</span> <span class="n">testStatementOrder</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">NiceMock</span><span class="o">&lt;</span><span class="n">MockCar</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">c</span><span class="p">.</span><span class="n">startEngine</span><span class="p">();</span>
  <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">startEngine</span><span class="p">()).</span><span class="n">Times</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*
[----------] 1 test from CarMockTest
[ RUN      ] CarMockTest.testStatementOrder
/home/sdargo/personal/dev/LeapYear/tests/LeapYearFixtureTests.cpp:64: Failure
Actual function call count doesn't match EXPECT_CALL(c, startEngine())...
         Expected: to be called once
           Actual: never called - unsatisfied and active
[  FAILED  ] CarMockTest.testStatementOrder (0 ms)
[----------] 1 test from CarMockTest (0 ms total)
*/</span>
</pre></table></code></div></div><p>Make sure that you make your expectation first and your test will work as intended:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">TEST</span><span class="p">(</span><span class="n">CarMockTest</span><span class="p">,</span> <span class="n">testStatementOrder</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">NiceMock</span><span class="o">&lt;</span><span class="n">MockCar</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">startEngine</span><span class="p">()).</span><span class="n">Times</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">c</span><span class="p">.</span><span class="n">startEngine</span><span class="p">();</span>
<span class="p">}</span>
<span class="cm">/*
[----------] 1 test from CarMockTest
[ RUN      ] CarMockTest.testStatementOrder
[       OK ] CarMockTest.testStatementOrder (0 ms)
[----------] 1 test from CarMockTest (0 ms total)
*/</span>
</pre></table></code></div></div><p>Probably this sounds too obvious, but in my experience it’s a common mistake that I also often made in the early days.</p><h3 id="dont-return-dangling-pointers">Don’t return dangling pointers</h3><p>The normal rules of thumb of C++ apply during mocking too. If you want the mock to return a pointer, you have to make sure that it points to a valid location in memory.</p><p>It happens that when you have to do the same setup for multiple test cases, you extract the code that arranges the test scenario into its own function.</p><p>In this case, you have to make sure that if a pointer or reference is returned, it’s not pointing to a local object as the same restrictions apply as otherwise.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">CarMockTest</span> <span class="o">:</span> <span class="k">public</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">Test</span> <span class="p">{</span>
<span class="nl">protected:</span>

  <span class="n">MyInt</span> <span class="n">Setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="n">MyInt</span><span class="p">{</span><span class="mi">420</span><span class="p">};</span>
    <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">getTrunkSize</span><span class="p">()).</span><span class="n">Times</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">WillRepeatedly</span><span class="p">(</span><span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">ReturnPointee</span><span class="p">(</span><span class="o">&amp;</span><span class="n">size</span><span class="p">));</span> <span class="c1">// returning a dangling pointer</span>
  <span class="p">}</span>

  <span class="n">MockCar</span> <span class="n">c</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><p>The above case is erroneus, as due to <code class="language-plaintext highlighter-rouge">Setup()</code>, <code class="language-plaintext highlighter-rouge">getTrunkSize()</code> will return a something that got already destroyed. <code class="language-plaintext highlighter-rouge">ReturnPointee</code> returns a value pointed at by a pointer, and in this case it’s just a local variable, therefore it is destoryed by the time it gets called.</p><p>You have 3 ways to fix this:</p><ul><li>don’t extract the setup<li>don’t use <code class="language-plaintext highlighter-rouge">ReturnPointee</code> - in any case, if not needed, just use <code class="language-plaintext highlighter-rouge">Return</code><li>with <code class="language-plaintext highlighter-rouge">ReturnPointee</code> use something that lives as long as the fixture, like a <code class="language-plaintext highlighter-rouge">std::unique_ptr</code> declared as a member</ul><h3 id="scattering-your-results-with-uninteresting-mock-calls">Scattering your results with uninteresting mock calls</h3><p>This might happen when you have a bit too many mocked methods. You mock many methods in the same fixture that got often called, but as you are not interested in all of them in all your test cases, you don’t set any expectations on them.</p><p>Then, when running your test that calls something you didn’t define a behaviour for, you might get something like this:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>GMOCK WARNING:
Uninteresting mock function call - returning default value.
    Function call: getTrunkSize()
          Returns: 0
NOTE: You can safely ignore the above warning unless this call should not happen.  Do not suppress it by blindly adding an EXPECT_CALL() if you don't mean to enforce the call.  See https://github.com/google/googletest/blob/master/googlemock/docs/cook_book.md#knowing-when-to-expect for details.
</pre></table></code></div></div><p>You have 2 ways to get rid of this.</p><p>The first one is to fix your tests in a way that you don’t call unnecessary mocked methods. This can be achieved by making sure that those unnecessary methods are not called or by actually providing a behaviour for them. But this latter is indeed superfluous as the test worked already without. I would go with simplifying the tests.</p><p>The other way is to not use a regular mock object, but a <code class="language-plaintext highlighter-rouge">NiceMock</code>. <code class="language-plaintext highlighter-rouge">NiceMock&lt;T&gt;</code> and <code class="language-plaintext highlighter-rouge">StrictMock&lt;T&gt;</code> are class templates, wrappers that you use when you create your mocked objects. They modify the behaviour in case of uninteresting function calls.</p><p>By default, as we saw a few paragraphs before, <em>gMock</em> emits warnings. With <code class="language-plaintext highlighter-rouge">NiceMock</code> you don’t receive any such warning while <code class="language-plaintext highlighter-rouge">StrictMock</code> will fail your test for any uninteresting function call.</p><h2 id="conclusion">Conclusion</h2><p>Today, in this second article on mocking we discussed how we can mock a non-<code class="language-plaintext highlighter-rouge">virtual</code> member function or a free function. We saw what changes we have to make in our code to make them testable.</p><p>Once we turned them into testable code, their mocking goes the same way as explained in the <a href="https://www.sandordargo.com/blog/2022/03/02/mocking-non-virtual-and-free-functions">previous article</a>.</p><p>We also saw a couple of common pitfalls that we must avoid when we try to mock our classes.</p><h2 id="connect-deeper">Connect deeper</h2><p>If you liked this article, please</p><ul><li>hit on the like button,<li><a href="http://eepurl.com/gvcv1j">subscribe to my newsletter</a><li>and let’s connect on <a href="https://twitter.com/SandorDargo">Twitter</a>!</ul><a href="https://www.patreon.com/sandordargo" style="float: left; padding-left: 0;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://c5.patreon.com/external/logo/become_a_patron_button.png" style="float: left; padding-left: 0;"></a></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/dev/'>dev</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cpp/" class="post-tag no-text-decoration" >cpp</a> <a href="/tags/virtual/" class="post-tag no-text-decoration" >virtual</a> <a href="/tags/mocking/" class="post-tag no-text-decoration" >mocking</a> <a href="/tags/gmock/" class="post-tag no-text-decoration" >gmock</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><a href="https://www.patreon.com/sandordargo" style="float: left; padding-left: 0;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://c5.patreon.com/external/logo/become_a_patron_button.png" style="float: left; padding-left: 0;"></a><div class="share-wrapper"> <a href="https://www.patreon.com/sandordargo" style="float: left; padding-left: 0;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://c5.patreon.com/external/logo/become_a_patron_button.png" style="float: left; padding-left: 0;"></a> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Mocking non-virtual and free functions with gMock - Sandor Dargo's Blog&url=https://www.sandordargo.com/blog/2022/03/09/mocking-non-virtual-and-free-functions" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Mocking non-virtual and free functions with gMock - Sandor Dargo's Blog&u=https://www.sandordargo.com/blog/2022/03/09/mocking-non-virtual-and-free-functions" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Mocking non-virtual and free functions with gMock - Sandor Dargo's Blog&url=https://www.sandordargo.com/blog/2022/03/09/mocking-non-virtual-and-free-functions" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://news.ycombinator.com/submitlink?t=Mocking non-virtual and free functions with gMock - Sandor Dargo's Blog&u=https://www.sandordargo.com/blog/2022/03/09/mocking-non-virtual-and-free-functions" data-toggle="tooltip" data-placement="top" title="HackerNews" target="_blank" rel="noopener" aria-label="HackerNews"> <i class="fa-fw fab fa-hacker-news"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2026/01/21/clocks-part-8-cpp20-timezones">Time in C++: C++20 Brought Us Time Zones</a><li><a href="/blog/2019/04/10/lesson-of-a-booking-dont-trust-the-system">Lesson of a booking: Don't trust the system!</a><li><a href="/blog/2020/07/22/always-catch-exceptions-by-reference">Why should we always catch exceptions by reference?</a><li><a href="/blog/2020/11/28/emergent-design">Emergent Design: The Evolutionary Nature of Professional Software Development by Scott Bain</a><li><a href="/blog/2021/10/06/airy-code-reviews">Bring some fresh AIR and write effective code review comments</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/watercooler/">watercooler</a> <a class="post-tag" href="/tags/career/">career</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/cpp23/">cpp23</a> <a class="post-tag" href="/tags/stl/">stl</a> <a class="post-tag" href="/tags/algorithms/">algorithms</a> <a class="post-tag" href="/tags/self-improvement/">self-improvement</a> <a class="post-tag" href="/tags/management/">management</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2022/03/02/mocking-non-virtual-and-free-functions"><div class="card-body"> <span class="timeago small" > Mar 2, 2022 <i class="unloaded">2022-03-02T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mocking virtual functions with gMock</h3><div class="text-muted small"><p> In this mini-series we are going to discover mocking with gMock, the probably most widely used C++ mocking framework. I think that practical discussions should start with theoretical ones. In orde...</p></div></div></a></div><div class="card"> <a href="/blog/2018/07/05/cpp-override"><div class="card-body"> <span class="timeago small" > Jul 5, 2018 <i class="unloaded">2018-07-05T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Why to use the override specifier in C++ 11?</h3><div class="text-muted small"><p> The override specifier was introduced to the language with C++11 and it is one of the easiest tool to significantly improve the maintainability of our codebases. override tells both the reader an...</p></div></div></a></div><div class="card"> <a href="/blog/2021/11/24/production-issues-part-i-undefined-behaviour"><div class="card-body"> <span class="timeago small" > Nov 24, 2021 <i class="unloaded">2021-11-24T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>I broke production 3 times in 3 weeks - Part I</h3><div class="text-muted small"><p> Are you a careful coder who barely introduces errors? How do you feel when still manage to bring production down? You might feel horrible, but I think you should take it as an opportunity. You can...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2022/03/05/secondhand-time-by-svetlana-alexievich" class="btn btn-outline-primary" prompt="Older"><p>Secondhand Time: The Last of the Soviets by Svetlana Alexievich</p></a> <a href="/blog/2022/03/16/iterators-vs-pointers" class="btn btn-outline-primary" prompt="Newer"><p>C++ basics: Pointers vs iterators</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//sandordargo-github-io.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Mocking non-virtual and free functions with gMock'; this.page.url = 'https://www.sandordargo.com/blog/2022/03/09/mocking-non-virtual-and-free-functions'; this.page.identifier = '/blog/2022/03/09/mocking-non-virtual-and-free-functions'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><div id="amzn-assoc-ad-be5a767b-3346-40aa-bc00-2eff0ce33d2b"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=be5a767b-3346-40aa-bc00-2eff0ce33d2b"></script> <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script> <script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">require(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us16.list-manage.com","uuid":"b073dbd5c29322302f59a8cd8","lid":"d26240427e"}) })</script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/SandorDargo">Sandor Dargo</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/watercooler/">watercooler</a> <a class="post-tag" href="/tags/career/">career</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/cpp23/">cpp23</a> <a class="post-tag" href="/tags/stl/">stl</a> <a class="post-tag" href="/tags/algorithms/">algorithms</a> <a class="post-tag" href="/tags/self-improvement/">self improvement</a> <a class="post-tag" href="/tags/management/">management</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.sandordargo.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
