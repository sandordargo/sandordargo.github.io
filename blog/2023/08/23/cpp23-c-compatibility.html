<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="C++23: compatibility with C" /><meta property="og:locale" content="en_US" /><meta name="description" content="In this blog post, let’s see two papers in C++23 that are being introduced due to compatibility with C. The &lt;stdatomic.h&gt; header Originally, atomics for C and C++ were designed together. The aim was to make the non-generic pieces of the C++ atomics library usable as a C library. Due to some design decisions during C++11 and C++14 standardization, this aim was not reached. As a consequence, if you want to use atomics and want to write code that is portable between C and C++, you’ll probably end up using preprocessor macros to decide which header to include. In case of C++, you’ll also import the necessary types to the global namespace. (The below example is taken from the proposal) 1 2 3 4 5 6 7 8 9 10 11 #ifdef __cplusplus #include &lt;atomic&gt; using std::atomic_int; using std::memory_order; using std::memory_order_acquire; ... #else /* not __cplusplus */ #include &lt;stdatomic.h&gt; #endif /* __cplusplus */ ... int saturated_fetch_add(atomic_int *loc, int value, memory_order order); Please note that this approach assumes that C and C++ representations of atomics are compatible. P0943R6 proposes the introduction of the header called &lt;stdatomic.h&gt; which will “mirror the identically named C header, and provide comparable functionality”. This header does 3 things: It includes the &lt;atomic&gt; C++ header Defines a macro such as atomic_generic_type(T) as std::atomic&lt;T&gt;. This assumes that C would correspondingly define atomic_generic_type(T) as _Atomic(T). Introduces types in the std namespace starting with atomic_ and memory_oder_ to the global namespace through aliases. The proposal doesn’t look for providing equivalence between C and C++ implementations, as it wants to avoid significant language changes. It provides the minimum required to conveniently use atomics in shared headers. Labels at the end of compound statements There is another proposal accepted to C++23 due to compatibility reasons with C, P2324R2. Labels show that compatibility-fueled changes go both ways. Earlier, a change was adopted for C2x allowing placing labels everywhere inside a compound statement, even in front of the declaration. Let’s demonstrate it with an example. 1 2 3 4 void foo() { first: int x; } The label first used to be allowed only in C++, but not in C. It’s due to grammar differences between the two languages. In C, declarations and statements are separate production rules and they can both appear as block-items inside compound statements. To fix the above difference, C allowed also labels as independent block items. But that led to another difference. Now in C, you can put a label at the end of a compound statement. 1 2 3 4 5 void foo() { // some code /// ... last_label: } In C++, labels can be attached to all statements, but they cannot be placed at the end of a compound statement, so the above example is invalid in C++. At least it used to be. The change proposal is accepted for C++23, GCC 13 and Clang 16 already implemented it. Conclusion In this article, we reviewed two changes aiming for higher compatibility with C. The introduction of &lt;stdatomic.h&gt; header makes it easier to have shared headers between C anc C++ when atomics are used. The second change allows to have labels at the end of compound statements, so for example at the very of a function. But we also saw that it’s not only C++ that introduces compatibility changes but also C when it started to allow having labels in front of variable declarations. By the way, who is using labels in new code? Connect deeper If you liked this article, please hit on the like button, subscribe to my newsletter and let’s connect on Twitter!" /><meta property="og:description" content="In this blog post, let’s see two papers in C++23 that are being introduced due to compatibility with C. The &lt;stdatomic.h&gt; header Originally, atomics for C and C++ were designed together. The aim was to make the non-generic pieces of the C++ atomics library usable as a C library. Due to some design decisions during C++11 and C++14 standardization, this aim was not reached. As a consequence, if you want to use atomics and want to write code that is portable between C and C++, you’ll probably end up using preprocessor macros to decide which header to include. In case of C++, you’ll also import the necessary types to the global namespace. (The below example is taken from the proposal) 1 2 3 4 5 6 7 8 9 10 11 #ifdef __cplusplus #include &lt;atomic&gt; using std::atomic_int; using std::memory_order; using std::memory_order_acquire; ... #else /* not __cplusplus */ #include &lt;stdatomic.h&gt; #endif /* __cplusplus */ ... int saturated_fetch_add(atomic_int *loc, int value, memory_order order); Please note that this approach assumes that C and C++ representations of atomics are compatible. P0943R6 proposes the introduction of the header called &lt;stdatomic.h&gt; which will “mirror the identically named C header, and provide comparable functionality”. This header does 3 things: It includes the &lt;atomic&gt; C++ header Defines a macro such as atomic_generic_type(T) as std::atomic&lt;T&gt;. This assumes that C would correspondingly define atomic_generic_type(T) as _Atomic(T). Introduces types in the std namespace starting with atomic_ and memory_oder_ to the global namespace through aliases. The proposal doesn’t look for providing equivalence between C and C++ implementations, as it wants to avoid significant language changes. It provides the minimum required to conveniently use atomics in shared headers. Labels at the end of compound statements There is another proposal accepted to C++23 due to compatibility reasons with C, P2324R2. Labels show that compatibility-fueled changes go both ways. Earlier, a change was adopted for C2x allowing placing labels everywhere inside a compound statement, even in front of the declaration. Let’s demonstrate it with an example. 1 2 3 4 void foo() { first: int x; } The label first used to be allowed only in C++, but not in C. It’s due to grammar differences between the two languages. In C, declarations and statements are separate production rules and they can both appear as block-items inside compound statements. To fix the above difference, C allowed also labels as independent block items. But that led to another difference. Now in C, you can put a label at the end of a compound statement. 1 2 3 4 5 void foo() { // some code /// ... last_label: } In C++, labels can be attached to all statements, but they cannot be placed at the end of a compound statement, so the above example is invalid in C++. At least it used to be. The change proposal is accepted for C++23, GCC 13 and Clang 16 already implemented it. Conclusion In this article, we reviewed two changes aiming for higher compatibility with C. The introduction of &lt;stdatomic.h&gt; header makes it easier to have shared headers between C anc C++ when atomics are used. The second change allows to have labels at the end of compound statements, so for example at the very of a function. But we also saw that it’s not only C++ that introduces compatibility changes but also C when it started to allow having labels in front of variable declarations. By the way, who is using labels in new code? Connect deeper If you liked this article, please hit on the like button, subscribe to my newsletter and let’s connect on Twitter!" /><link rel="canonical" href="https://www.sandordargo.com/blog/2023/08/23/cpp23-c-compatibility" /><meta property="og:url" content="https://www.sandordargo.com/blog/2023/08/23/cpp23-c-compatibility" /><meta property="og:site_name" content="Sandor Dargo’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-08-23T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="C++23: compatibility with C" /><meta name="twitter:site" content="@SandorDargo" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-08-23T16:26:09+02:00","datePublished":"2023-08-23T00:00:00+02:00","description":"In this blog post, let’s see two papers in C++23 that are being introduced due to compatibility with C. The &lt;stdatomic.h&gt; header Originally, atomics for C and C++ were designed together. The aim was to make the non-generic pieces of the C++ atomics library usable as a C library. Due to some design decisions during C++11 and C++14 standardization, this aim was not reached. As a consequence, if you want to use atomics and want to write code that is portable between C and C++, you’ll probably end up using preprocessor macros to decide which header to include. In case of C++, you’ll also import the necessary types to the global namespace. (The below example is taken from the proposal) 1 2 3 4 5 6 7 8 9 10 11 #ifdef __cplusplus #include &lt;atomic&gt; using std::atomic_int; using std::memory_order; using std::memory_order_acquire; ... #else /* not __cplusplus */ #include &lt;stdatomic.h&gt; #endif /* __cplusplus */ ... int saturated_fetch_add(atomic_int *loc, int value, memory_order order); Please note that this approach assumes that C and C++ representations of atomics are compatible. P0943R6 proposes the introduction of the header called &lt;stdatomic.h&gt; which will “mirror the identically named C header, and provide comparable functionality”. This header does 3 things: It includes the &lt;atomic&gt; C++ header Defines a macro such as atomic_generic_type(T) as std::atomic&lt;T&gt;. This assumes that C would correspondingly define atomic_generic_type(T) as _Atomic(T). Introduces types in the std namespace starting with atomic_ and memory_oder_ to the global namespace through aliases. The proposal doesn’t look for providing equivalence between C and C++ implementations, as it wants to avoid significant language changes. It provides the minimum required to conveniently use atomics in shared headers. Labels at the end of compound statements There is another proposal accepted to C++23 due to compatibility reasons with C, P2324R2. Labels show that compatibility-fueled changes go both ways. Earlier, a change was adopted for C2x allowing placing labels everywhere inside a compound statement, even in front of the declaration. Let’s demonstrate it with an example. 1 2 3 4 void foo() { first: int x; } The label first used to be allowed only in C++, but not in C. It’s due to grammar differences between the two languages. In C, declarations and statements are separate production rules and they can both appear as block-items inside compound statements. To fix the above difference, C allowed also labels as independent block items. But that led to another difference. Now in C, you can put a label at the end of a compound statement. 1 2 3 4 5 void foo() { // some code /// ... last_label: } In C++, labels can be attached to all statements, but they cannot be placed at the end of a compound statement, so the above example is invalid in C++. At least it used to be. The change proposal is accepted for C++23, GCC 13 and Clang 16 already implemented it. Conclusion In this article, we reviewed two changes aiming for higher compatibility with C. The introduction of &lt;stdatomic.h&gt; header makes it easier to have shared headers between C anc C++ when atomics are used. The second change allows to have labels at the end of compound statements, so for example at the very of a function. But we also saw that it’s not only C++ that introduces compatibility changes but also C when it started to allow having labels in front of variable declarations. By the way, who is using labels in new code? Connect deeper If you liked this article, please hit on the like button, subscribe to my newsletter and let’s connect on Twitter!","headline":"C++23: compatibility with C","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.sandordargo.com/blog/2023/08/23/cpp23-c-compatibility"},"url":"https://www.sandordargo.com/blog/2023/08/23/cpp23-c-compatibility"}</script><title>C++23: compatibility with C | Sandor Dargo's Blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-89625019-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-89625019-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/SANDOR_DARGO_ROUND.JPG" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Sandor Dargo's Blog</a></div><div class="site-subtitle font-italic">On C++, software development and books</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/books/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>BOOKS</span> </a><li class="nav-item"> <a href="/speaking/" class="nav-link"> <i class="fa-fw fas fa-microphone ml-xl-3 mr-xl-3 unloaded"></i> <span>SPEAKING</span> </a><li class="nav-item"> <a href="/dailycpp/" class="nav-link"> <i class="fa-fw fas fa-link ml-xl-3 mr-xl-3 unloaded"></i> <span>DAILY C++</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>HI...</span> </a></ul><ul class="w-100"><li class="nav-item"> <a href="https://www.patreon.com/sandordargo" class="nav-link"> <img src="https://c5.patreon.com/external/logo/become_a_patron_button.png"></a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/sandordargo" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/SandorDargo" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sandor.dargo','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/blog"> Blog </a> </span> <span> <a href="/2023"> 2023 </a> </span> <span> <a href="/08"> 08 </a> </span> <span> <a href="/23"> 23 </a> </span> <span>C++23: compatibility with C</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>C++23: compatibility with C</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Sandor Dargo </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Aug 23, 2023, 12:00 AM +0200" prep="on" > Aug 23, 2023 <i class="unloaded">2023-08-23T00:00:00+02:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Aug 23, 2023, 4:26 PM +0200" prefix="Updated " > Aug 23, 2023 <i class="unloaded">2023-08-23T16:26:09+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="599 words">3 min</span></div></div><div class="post-content"><p>In this blog post, let’s see two papers in C++23 that are being introduced due to compatibility with C.</p><h2 id="the-stdatomich-header">The <code class="language-plaintext highlighter-rouge">&lt;stdatomic.h&gt;</code> header</h2><p>Originally, atomics for C and C++ were designed together. The aim was to make the non-generic pieces of the C++ atomics library usable as a C library. Due to some design decisions during C++11 and C++14 standardization, this aim was not reached.</p><p>As a consequence, if you want to use atomics and want to write code that is portable between C and C++, you’ll probably end up using <a href="https://www.sandordargo.com/blog/2022/09/07/prepocessive-directive-changes-in-cpp23">preprocessor macros</a> to decide which header to include. In case of C++, you’ll also import the necessary types to the global namespace. <em>(The below example is taken from the <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/p0943r6.html">proposal</a>)</em></p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="cp">#ifdef __cplusplus
</span>  <span class="cp">#include</span> <span class="cpf">&lt;atomic&gt;</span><span class="cp">
</span>  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">atomic_int</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">;</span>
  <span class="p">...</span>
<span class="cp">#else </span><span class="cm">/* not __cplusplus */</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;stdatomic.h&gt;</span><span class="cp">
#endif </span><span class="cm">/* __cplusplus */</span><span class="cp">
</span><span class="p">...</span>
<span class="kt">int</span> <span class="nf">saturated_fetch_add</span><span class="p">(</span><span class="n">atomic_int</span> <span class="o">*</span><span class="n">loc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">memory_order</span> <span class="n">order</span><span class="p">);</span>
</pre></table></code></div></div><p>Please note that this approach assumes that C and C++ representations of atomics are compatible.</p><p><a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/p0943r6.html">P0943R6</a> proposes the introduction of the header called <code class="language-plaintext highlighter-rouge">&lt;stdatomic.h&gt;</code> which will <em>“mirror the identically named C header, and provide comparable functionality”</em>.</p><p>This header does 3 things:</p><ul><li>It includes the <code class="language-plaintext highlighter-rouge">&lt;atomic&gt;</code> C++ header<li>Defines a macro such as <code class="language-plaintext highlighter-rouge">atomic_generic_type(T)</code> as <code class="language-plaintext highlighter-rouge">std::atomic&lt;T&gt;</code>. This assumes that C would correspondingly define <code class="language-plaintext highlighter-rouge">atomic_generic_type(T)</code> as <code class="language-plaintext highlighter-rouge">_Atomic(T)</code>.<li>Introduces types in the <code class="language-plaintext highlighter-rouge">std</code> namespace starting with <code class="language-plaintext highlighter-rouge">atomic_</code> and <code class="language-plaintext highlighter-rouge">memory_oder_</code> to the global namespace through aliases.</ul><p>The proposal doesn’t look for providing equivalence between C and C++ implementations, as it wants to avoid significant language changes. It provides the minimum required to conveniently use atomics in shared headers.</p><h2 id="labels-at-the-end-of-compound-statements">Labels at the end of compound statements</h2><p>There is another proposal accepted to C++23 due to compatibility reasons with <code class="language-plaintext highlighter-rouge">C</code>, <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2324r2.pdf">P2324R2</a>.</p><p>Labels show that compatibility-fueled changes go both ways. Earlier, a change was adopted for C2x allowing placing labels everywhere inside a compound statement, even in front of the declaration. Let’s demonstrate it with an example.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
	<span class="nl">first:</span>
		<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The label <code class="language-plaintext highlighter-rouge">first</code> used to be allowed only in C++, but not in C. It’s due to grammar differences between the two languages. In C, declarations and statements are separate production rules and they can both appear as block-items inside compound statements. To fix the above difference, C allowed also labels as independent block items. But that led to another difference. Now in C, you can put a label at the end of a compound statement.</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// some code</span>
	<span class="c1">/// ...</span>
	<span class="nl">last_label:</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In C++, labels can be attached to all statements, but they cannot be placed at the end of a compound statement, so the above example is invalid in C++. At least it used to be. The change proposal is accepted for C++23, GCC 13 and Clang 16 already implemented it.</p><h2 id="conclusion">Conclusion</h2><p>In this article, we reviewed two changes aiming for higher compatibility with C. The introduction of <code class="language-plaintext highlighter-rouge">&lt;stdatomic.h&gt;</code> header makes it easier to have shared headers between C anc C++ when atomics are used. The second change allows to have labels at the end of compound statements, so for example at the very of a function. But we also saw that it’s not only C++ that introduces compatibility changes but also C when it started to allow having labels in front of variable declarations. By the way, who is using labels in new code?</p><h2 id="connect-deeper">Connect deeper</h2><p>If you liked this article, please</p><ul><li>hit on the like button,<li><a href="http://eepurl.com/gvcv1j">subscribe to my newsletter</a><li>and let’s connect on <a href="https://twitter.com/SandorDargo">Twitter</a>!</ul><a href="https://www.patreon.com/sandordargo" style="float: left; padding-left: 0;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://c5.patreon.com/external/logo/become_a_patron_button.png" style="float: left; padding-left: 0;"></a></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/dev/'>dev</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cpp/" class="post-tag no-text-decoration" >cpp</a> <a href="/tags/cpp23/" class="post-tag no-text-decoration" >cpp23</a> <a href="/tags/labels/" class="post-tag no-text-decoration" >labels</a> <a href="/tags/atomics/" class="post-tag no-text-decoration" >atomics</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><a href="https://www.patreon.com/sandordargo" style="float: left; padding-left: 0;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://c5.patreon.com/external/logo/become_a_patron_button.png" style="float: left; padding-left: 0;"></a><div class="share-wrapper"> <a href="https://www.patreon.com/sandordargo" style="float: left; padding-left: 0;"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://c5.patreon.com/external/logo/become_a_patron_button.png" style="float: left; padding-left: 0;"></a> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=C++23: compatibility with C - Sandor Dargo's Blog&url=https://www.sandordargo.com/blog/2023/08/23/cpp23-c-compatibility" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=C++23: compatibility with C - Sandor Dargo's Blog&u=https://www.sandordargo.com/blog/2023/08/23/cpp23-c-compatibility" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=C++23: compatibility with C - Sandor Dargo's Blog&url=https://www.sandordargo.com/blog/2023/08/23/cpp23-c-compatibility" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://news.ycombinator.com/submitlink?t=C++23: compatibility with C - Sandor Dargo's Blog&u=https://www.sandordargo.com/blog/2023/08/23/cpp23-c-compatibility" data-toggle="tooltip" data-placement="top" title="HackerNews" target="_blank" rel="noopener" aria-label="HackerNews"> <i class="fa-fw fab fa-hacker-news"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2025/10/22/trip-report-budapest-cpp">Trip report: Budapest C++ - Breaking & Building C++</a><li><a href="/blog/2025/10/01/cpp26-optional-of-reference">C++26: std::optional&lt;T&amp;&gt;</a><li><a href="/blog/2025/09/24/trip-report-cppcon-2025">Trip report: CppCon 2025</a><li><a href="/blog/2025/07/23/format-your-own-type-part-1">Format your own type (Part 1)</a><li><a href="/blog/2025/07/02/cpponsea-trip-report">Trip report: C++ On Sea 2025</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/watercooler/">watercooler</a> <a class="post-tag" href="/tags/career/">career</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/cpp23/">cpp23</a> <a class="post-tag" href="/tags/stl/">stl</a> <a class="post-tag" href="/tags/algorithms/">algorithms</a> <a class="post-tag" href="/tags/self-improvement/">self-improvement</a> <a class="post-tag" href="/tags/management/">management</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2022/11/23/cpp23-changes-to-lambdas"><div class="card-body"> <span class="timeago small" > Nov 23, 2022 <i class="unloaded">2022-11-23T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>C++23: How lambdas are going to change?</h3><div class="text-muted small"><p> C++23 is coming soon and it will change how lambdas work in 3 different ways. They will not only become simpler in certain circumstances but they will be also aligned more with other features of th...</p></div></div></a></div><div class="card"> <a href="/blog/2022/11/30/cpp23-auto-and-decay-copy"><div class="card-body"> <span class="timeago small" > Nov 30, 2022 <i class="unloaded">2022-11-30T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>C++23: auto(x) and decay copy</h3><div class="text-muted small"><p> When I first saw auto I thought that woah, not so fast, how am I going to know the type of my variables? Then I started to understand that auto helps in so many different ways. It helps remove the ...</p></div></div></a></div><div class="card"> <a href="/blog/2022/12/07/inout_ptr-and-out_ptr"><div class="card-body"> <span class="timeago small" > Dec 7, 2022 <i class="unloaded">2022-12-07T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>C++23: std::out_ptr and std::inout_ptr</h3><div class="text-muted small"><p> This week, let’s continue exploring the new world of C++23. We are going to discuss two new standard library functions and their outputs (std::out_ptr, std::inout_ptr), two new standard library typ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2023/08/15/cpp23-mdspan-mdsarray" class="btn btn-outline-primary" prompt="Older"><p>C++23: mdspan</p></a> <a href="/blog/2023/08/30/the-value-of-boring-tasks" class="btn btn-outline-primary" prompt="Newer"><p>The value of boring tasks</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//sandordargo-github-io.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'C++23: compatibility with C'; this.page.url = 'https://www.sandordargo.com/blog/2023/08/23/cpp23-c-compatibility'; this.page.identifier = '/blog/2023/08/23/cpp23-c-compatibility'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><div id="amzn-assoc-ad-be5a767b-3346-40aa-bc00-2eff0ce33d2b"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=be5a767b-3346-40aa-bc00-2eff0ce33d2b"></script> <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script> <script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">require(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us16.list-manage.com","uuid":"b073dbd5c29322302f59a8cd8","lid":"d26240427e"}) })</script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/SandorDargo">Sandor Dargo</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/cpp/">cpp</a> <a class="post-tag" href="/tags/books/">books</a> <a class="post-tag" href="/tags/watercooler/">watercooler</a> <a class="post-tag" href="/tags/career/">career</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/cpp23/">cpp23</a> <a class="post-tag" href="/tags/stl/">stl</a> <a class="post-tag" href="/tags/algorithms/">algorithms</a> <a class="post-tag" href="/tags/self-improvement/">self improvement</a> <a class="post-tag" href="/tags/management/">management</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.sandordargo.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
